<!DOCTYPE html>
<html lang="pt-BR" style="font-size: 16px;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Ofertas v7.2</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --cor-primaria: #ef4444; --cor-secundaria: #3b82f6; --cor-fundo: #f8fafc; --cor-texto-principal: #1f2937; --cor-borda: #e5e7eb; }
        body { font-family: 'Inter', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto-principal); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        .card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid var(--cor-borda); }
        .btn { font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 0.75rem; transition: all 0.3s ease; outline: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-savegnago { background-color: #2563eb; color: #fff; } .btn-savegnago:hover { background-color: #1d4ed8; }
        .btn-paulistao { background-color: #dc2626; color: #fff; } .btn-paulistao:hover { background-color: #b91c1c; }
        .btn-neutral { background-color: #e5e7eb; color: #374151; } 
        .btn-warning { background-color: #f59e0b; color: #fff; } .btn-warning:hover { background-color: #d97706; }
        .btn-timer { background-color: #8b5cf6; color: #fff; } .btn-timer:hover { background-color: #7c3aed; }
        .btn-timer-active { background-color: #f97316; color: #fff; } .btn-timer-active:hover { background-color: #ea580c; }
        .btn-html { background-color: #0ea5e9; color: #fff; } .btn-html:hover { background-color: #0284c7; }
        .btn-excel { background-color: #16a34a; color: #fff; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { animation: fadeIn 0.3s ease forwards; width: 100%; }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast-message { padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: white; font-weight: 600; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); display: flex; align-items: center; gap: 0.75rem; }
        .toast-message.success { background-color: #22c55e; } .toast-message.error { background-color: #ef4444; }
        .sticky-header { position: sticky; top: 0; z-index: 10; background-color: #f9fafb; }
        tr.row-completed { background-color: #dcfce7 !important; } tr.row-completed td { color: #166534; }
        .order-input { width: 50px; text-align: center; border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.25rem; }
        
        .sku-link { display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px; background-color: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600; transition: background-color 0.2s; cursor: pointer; text-decoration: none;}
        .sku-link:hover { background-color: #bfdbfe; }
        .sku-link.visited-sku { background-color: #fee2e2 !important; color: #dc2626 !important; border: 1px solid #fecaca; }

        #accessibility-toolbar { z-index: 1050; }
        .btn-access { background-color: #fff; color: #374151; width: 48px; height: 48px; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; border: 1px solid #e5e7eb; transition: all 0.2s; }
        .btn-access:hover { background-color: var(--cor-secundaria); color: white; transform: translateX(-4px) scale(1.05); }
        body.high-contrast { background-color: #000 !important; color: #fff !important; }
        .high-contrast .card, .high-contrast input, .high-contrast textarea, .high-contrast .bg-white { background-color: #111 !important; color: #fff !important; border-color: #fff !important; }
        .high-contrast .btn-savegnago, .high-contrast .btn-paulistao { background-color: #ffff00 !important; color: #000 !important; }
        .high-contrast a { color: #ffff00 !important; }
        .high-contrast img:not(.inverted) { filter: invert(1) grayscale(1); }
    </style>
</head>
<body class="text-gray-800">

    <div id="accessibility-toolbar" class="fixed top-1/2 -translate-y-1/2 right-0 flex flex-col gap-2 bg-white p-2 rounded-l-lg shadow-lg border border-r-0">
        <button id="increase-font" class="btn-access" title="Aumentar Fonte"><i class="fa-solid fa-plus"></i></button>
        <button id="decrease-font" class="btn-access" title="Diminuir Fonte"><i class="fa-solid fa-minus"></i></button>
        <button id="high-contrast" class="btn-access" title="Alto Contraste"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <button id="reset-accessibility" class="btn-access" title="Redefinir Acessibilidade"><i class="fa-solid fa-arrow-rotate-left"></i></button>
    </div>

    <div id="toast-container"></div>

    <div id="listTypeModal" class="modal-overlay p-4 visible">
        <div class="modal-content card p-6 md:p-8 text-center max-w-sm">
            <h2 class="text-2xl font-extrabold text-gray-900 mb-4">Qual rede voc√™ deseja analisar?</h2>
            <div class="flex flex-col space-y-4">
                <button id="selectSavegnago" class="btn btn-savegnago">Savegnago Supermercados</button>
                <button id="selectPaulistao" class="btn btn-paulistao">Paulist√£o Atacadista</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-6 max-w-[95%] min-h-screen flex flex-col">
        <header class="text-center py-6 mb-6 flex justify-center items-center relative gap-4">
            <img id="headerLogo" src="https://savegnagoio.vtexassets.com/assets/vtex/assets-builder/savegnagoio.store-theme/14.0.36/home/logo-save___ee8753fa9fd1e21018b817a0d020549f.png" alt="Logo Rede" class="h-12 md:h-16 inverted">
        </header>

        <main class="flex-grow">
            <div class="card p-6 md:p-8 mb-8">
                <h1 class="text-2xl font-extrabold text-gray-900 text-center mb-2">Analisador de Ofertas v7.2</h1>
                <p class="text-center text-gray-500 mb-6">Auditoria Completa, Corre√ß√£o Autom√°tica e Sincronia de Redes</p>
                
                <textarea id="inputText" class="w-full h-60 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm mb-4" placeholder="Cole aqui o texto das ofertas..."></textarea>
                
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                    <button id="parseButton" class="btn btn-neutral hover:bg-gray-300"><i class="fa-solid fa-wand-magic-sparkles"></i><span id="buttonText">Analisar</span><div id="loadingSpinner" class="spinner hidden"></div></button>
                    <button id="timerButton" class="btn btn-timer"><i class="fa-solid fa-stopwatch"></i><span id="timerButtonText">Timer</span></button>
                    <button onclick="generateSalesforceHTML(0)" class="btn btn-html"><i class="fa-solid fa-code"></i> HTML</button>
                    <button id="clearButton" class="btn btn-neutral"><i class="fa-solid fa-trash-can"></i> Limpar</button>
                </div>

                <div id="liveTimerContainer" class="hidden text-center bg-gray-50 border border-gray-200 rounded p-2 mb-4">
                    <span class="text-gray-500 text-xs uppercase font-bold tracking-wider">Tempo Decorrido</span>
                    <div id="liveTimer" class="text-2xl font-mono font-bold text-gray-800">00:00:00</div>
                </div>

                <div id="timerLog" class="space-y-2"></div>
            </div>

            <div id="resultsContainer"></div>
        </main>

        <footer class="text-center mt-12 py-6 text-gray-500 text-sm border-t border-gray-200">
            <p>Criador: Luan Candido | Programado por: Rendrix Oliveira - Grupo Savegnago</p>
            <p class="mt-1">v.7.2.0 (Bugfix Bot√£o Analisar) - 2026</p>
        </footer>
    </div>

    <script>
        const CITIES_SAVEGNAGO = [
            "Americana", "Araraquara", "Araras", "Barretos", "Bebedouro", "Campinas", "Franca", 
            "Hortol√¢ndia", "Indaiatuba", "Jaboticabal", "Jardin√≥polis", "Leme", "Limeira", "Mat√£o", 
            "Monte Alto", "Piracicaba", "Ribeir√£o Preto", "Rio Claro", "S√£o Carlos", "Sert√£ozinho", "Sumar√©"
        ];

        const CITIES_PAULISTAO = [
            "Araraquara", "Barretos", "Campinas", "Franca", "Ribeir√£o Preto", 
            "Santa B√°rbara d'Oeste", "Rio Claro", "Sert√£ozinho"
        ];

        let MASTER_CITIES = [];
        let selectedOfferType = null;
        window.globalParsedBlocks = [];

        // --- TIMER ---
        let timerInterval;
        let timerStartTime;
        let isTimerRunning = false;
        const timerBtn = document.getElementById('timerButton');
        const timerBtnText = document.getElementById('timerButtonText');
        const liveTimerDisplay = document.getElementById('liveTimer');
        const liveTimerContainer = document.getElementById('liveTimerContainer');
        const timerLog = document.getElementById('timerLog');

        timerBtn.addEventListener('click', () => {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerStartTime = new Date();
                timerBtn.classList.replace('btn-timer', 'btn-timer-active');
                timerBtnText.textContent = "Salvar";
                timerBtn.querySelector('i').className = "fa-solid fa-floppy-disk";
                liveTimerContainer.classList.remove('hidden');
                timerInterval = setInterval(() => {
                    const now = new Date();
                    const diff = now - timerStartTime;
                    const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                    const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                    const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                    liveTimerDisplay.textContent = `${h}:${m}:${s}`;
                }, 1000);
            } else {
                clearInterval(timerInterval);
                const timerEndTime = new Date();
                const duration = liveTimerDisplay.textContent;
                const dateStr = timerStartTime.toLocaleDateString('pt-BR');

                const logItem = document.createElement('div');
                logItem.className = 'bg-blue-50 border border-blue-200 rounded p-3 flex flex-col sm:flex-row justify-between items-center text-sm animate-fade-in';
                logItem.innerHTML = `<div class="flex gap-4 items-center">
                    <span class="text-blue-800 font-bold bg-blue-100 px-2 rounded">${dateStr}</span>
                    <span class="text-gray-600"><i class="fa-regular fa-clock"></i> In√≠cio: <b>${timerStartTime.toLocaleTimeString()}</b></span>
                    <span class="text-gray-600">Fim: <b>${timerEndTime.toLocaleTimeString()}</b></span>
                </div>
                <div class="font-bold text-blue-700 mt-1 sm:mt-0"><i class="fa-solid fa-hourglass-end"></i> Dura√ß√£o: ${duration}</div>`;
                timerLog.prepend(logItem);
                isTimerRunning = false;
                timerBtn.classList.replace('btn-timer-active', 'btn-timer');
                timerBtnText.textContent = "Timer";
                timerBtn.querySelector('i').className = "fa-solid fa-stopwatch";
                liveTimerContainer.classList.add('hidden');
                liveTimerDisplay.textContent = "00:00:00";
            }
        });

        // --- Core ---
        function cleanString(str) { return str ? str.replace(/^[\s\u200B-\u200D\uFEFF‚Ä¢‚óè>*-]+/, '').trim() : ''; }
        function nuclearNormalize(str) { return str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "") : ""; }

        function toTitleCase(str) {
            if (!str) return '';
            const cleaned = cleanString(str);
            return cleaned.toLowerCase().split(' ').map(word => {
                if (['e', 'de', 'da', 'do', 'dos', 'das', "d'", 'sem', 'osso', 'com', 'ao', 'em'].includes(word.toLowerCase())) return word.toLowerCase();
                if (word.replace(/['‚Äô‚Äò`]/g, "'").toLowerCase().includes("d'oeste")) return "d'Oeste"; 
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
        }

        // --- FUN√á√ÉO DE CORRE√á√ÉO (ATUALIZADA) ---
        function autoCorrectText(text) {
            if (!text) return text;

            // Regex segura para litros
            text = text.replace(/\b(\d+([.,]\d+)?)\s*l\b/gi, '$1L');
            text = text.replace(/\b1,5\s*-/g, '1,5L');

            const dictionary = {
                'mu√ßarela': 'Mussarela',
                'mussarela': 'Mussarela',
                'pateko': 'Pat√©ko',
                'contra fil√©': 'Contrafil√©',
                'contra-fil√©': 'Contrafil√©',
                'contrafil√©': 'Contrafil√©',
                'p√™ra': 'Pera',
                'pera': 'Pera',
                'tub': 'Tubo',
                'tubo': 'Tubo',
                'mms': 'M&Ms',
                'm&m': 'M&Ms',
                'm&ms': 'M&Ms',
                'kilo': 'kg',
                'sbp': 'SBP',
                'off': 'OFF',
                'on': 'ON'
            };

            Object.keys(dictionary).forEach(key => {
                const regex = new RegExp(`\\b${key}\\b`, 'gi');
                text = text.replace(regex, dictionary[key]);
            });

            return text;
        }

        function capitalizeDescription(description) { 
            if (!description) return "";
            return description.split(' ').map(word => {
                if (['e', 'de', 'da', 'do', 'dos', 'das', 'com', 'sem', 'em', 'por', 'para', 'ao'].includes(word.toLowerCase())) {
                    return word.toLowerCase();
                }
                if (['SBP', 'OFF', 'ON', 'M&Ms', '1L', '2L', '3L', '5L', '10L', '1,5L', '1.5L', '1,3L'].includes(word)) {
                    return word; 
                }
                if (/\d/.test(word)) return word;

                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-message ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) { if (show) modal.classList.add('visible'); else modal.classList.remove('visible'); }
        }

        function copyAndAnimate(text, elementId) {
            navigator.clipboard.writeText(text).then(() => {
                const el = document.getElementById(elementId);
                if(el) { el.style.textDecoration = 'line-through'; el.classList.add('text-gray-400'); }
                showToast("Texto copiado!");
            });
        }

        function copySimpleText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`C√≥digo ${text} copiado!`);
            });
        }

        function copyLinkUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast(`Link copiado!`);
            });
        }

        function copyCitiesText(containerId) {
            const el = document.getElementById(containerId);
            if (el) {
                const text = el.innerText.trim();
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Cidades copiadas!");
                });
            }
        }

        function formatPrice(price) {
            if (price === 'INFO_MISSING') return '<span class="text-[10px] text-gray-500 italic leading-tight block">Sem pre√ßo<br>informado</span>';
            if (!price) return '‚Äî';
            const numPrice = parseFloat(String(price).replace(',', '.'));
            return isNaN(numPrice) ? '‚Äî' : `R$ ${numPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        }

        function markLinkAsVisited(element) {
            element.classList.add('visited-sku');
        }

        function generateSalesforceHTML(blockIndex) {
            const block = window.globalParsedBlocks[blockIndex];
            if (!block) return;

            let htmlOutput = `<table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; font-family: Arial, sans-serif;">`;
            
            block.products.forEach((product) => {
                let normalPrice = product.priceNormal ? `R$ ${product.priceNormal}` : "";
                let specialPrice = "";
                let specialLabel = "";
                
                if (selectedOfferType === 'SAVEGNAGO' && product.priceSaveGanhe && product.priceSaveGanhe !== 'INFO_MISSING') {
                    specialPrice = `R$ ${product.priceSaveGanhe}`;
                    specialLabel = "Save Ganhe";
                } else if (selectedOfferType === 'SAVEGNAGO' && product.priceNossoCartao && product.priceNossoCartao !== 'INFO_MISSING') {
                    specialPrice = `R$ ${product.priceNossoCartao}`;
                    specialLabel = "Nosso Cart√£o";
                } else if (selectedOfferType === 'PAULISTAO' && product.priceClienteCampeao && product.priceClienteCampeao !== 'INFO_MISSING') {
                    specialPrice = `R$ ${product.priceClienteCampeao}`;
                    specialLabel = "Cliente Campe√£o";
                } else if (selectedOfferType === 'PAULISTAO' && product.priceNossoCartao && product.priceNossoCartao !== 'INFO_MISSING') {
                    specialPrice = `R$ ${product.priceNossoCartao}`;
                    specialLabel = "Nosso Cart√£o";
                }

                let code = product.code && product.code !== '-' ? product.code.split('/')[0] : '';
                let linkUrl = code ? (selectedOfferType === 'SAVEGNAGO' ? `https://www.savegnago.com.br/${code}` : '#') : '#';
                
                htmlOutput += `<tr><td style="padding: 10px; border-bottom: 1px solid #ddd; width: 100px; text-align: center;"><a href="${linkUrl}" target="_blank" style="text-decoration:none;"><img src="https://placehold.co/100x100?text=IMG-${code}" alt="${product.description}" width="100" style="display:block; border:0;" /></a></td><td style="padding: 10px; border-bottom: 1px solid #ddd; vertical-align: middle;"><a href="${linkUrl}" target="_blank" style="text-decoration:none; color: #333;"><strong style="font-size: 14px;">${product.description}</strong></a>${product.extraInfo ? `<div style="font-size: 12px; color: #666;">${product.extraInfo}</div>` : ''}</td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: right; vertical-align: middle;">${normalPrice ? `<div style="font-size: 14px; color: #333;">${normalPrice}</div>` : ''}${specialPrice ? `<div style="font-size: 16px; color: #d00; font-weight: bold;">${specialPrice} <span style="font-size:10px; font-weight:normal;">(${specialLabel})</span></div>` : ''}</td></tr>`;
            });

            htmlOutput += `</table>`;
            navigator.clipboard.writeText(htmlOutput).then(() => { showToast("HTML para Salesforce copiado!"); });
        }

        // --- GERA LINKS COM EFEITO VERMELHO AO CLICAR ---
        function generateSkuLinks(codeString) {
            if (!codeString || codeString === '-') return '-';
            const cleanString = codeString.replace(/red\./gi, '').replace(/[()]/g, '');
            const codes = cleanString.split(/[/-]/).map(c => c.trim()).filter(c => /^\d+$/.test(c));
            
            if (codes.length === 0) return codeString;
            
            const baseUrl = (selectedOfferType === 'SAVEGNAGO') 
                ? 'https://www.savegnago.com.br/' 
                : 'https://www.paulistaoatacadista.com.br/';
            
            return codes.map(code => {
                const fullUrl = `${baseUrl}${code}`;
                return `
                <div class="flex items-center gap-1 mb-1 last:mb-0 bg-blue-50 p-1 rounded border border-blue-100">
                    <a href="${fullUrl}" target="_blank" class="sku-link flex-grow text-center" title="Abrir produto ${code}" onclick="markLinkAsVisited(this)">
                        ${code} <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-[0.6rem]"></i>
                    </a>
                    <button onclick="copySimpleText('${code}')" class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-blue-100" title="Copiar c√≥digo"><i class="fa-regular fa-file"></i></button>
                    <button onclick="copyLinkUrl('${fullUrl}')" class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-blue-100" title="Copiar Link"><i class="fa-solid fa-link"></i></button>
                </div>`;
            }).join('');
        }

        function formatCityDisplayList(citiesArray) {
            if (!citiesArray || citiesArray.length === 0) return "";
            const unique = [...new Set(citiesArray)];
            unique.sort((a, b) => a.localeCompare(b));
            const formatted = unique.map(c => toTitleCase(c));
            if (formatted.length === 1) return formatted[0];
            const last = formatted.pop();
            return formatted.join(', ') + ' e ' + last;
        }

        function renderResultsTable(products, resultsContainer, locationTitle, cityList, blockIndex) {
            const blockContainer = document.createElement('div');
            blockContainer.className = 'mb-10';
            
            let buttonsHtml = '';
            if (blockIndex === 0) {
                buttonsHtml += `<button onclick="reorderAllTables()" class="btn btn-warning py-2 px-3 text-sm"><i class="fa-solid fa-arrow-down-1-9"></i> Reordenar Todas</button>`;
            }
            buttonsHtml += `<button onclick="generateSalesforceHTML(${blockIndex})" class="btn btn-html py-2 px-3 text-sm"><i class="fa-solid fa-code"></i> HTML</button>`;
            buttonsHtml += `<button onclick="exportToExcel(${blockIndex})" class="btn btn-excel py-2 px-3 text-sm"><i class="fa-solid fa-file-excel"></i> Excel</button>`;

            const formattedCities = formatCityDisplayList(cityList);
            let displayTitle = (blockIndex === 0) ? "LISTA GERAL (RESTANTE)" : `LISTA ESPEC√çFICA ${blockIndex}`;
            
            const citiesHtml = formattedCities 
                ? `<div class="bg-gray-50 p-2 rounded border border-gray-100 mt-2 flex justify-between items-start gap-2">
                    <p class="text-sm text-gray-600 font-medium" id="cities-text-${blockIndex}"><i class="fa-solid fa-map-pin text-red-500 mr-1"></i> ${formattedCities}</p>
                    <button onclick="copyCitiesText('cities-text-${blockIndex}')" class="text-gray-400 hover:text-blue-600 text-sm whitespace-nowrap" title="Copiar cidades"><i class="fa-regular fa-copy"></i> Copiar</button>
                   </div>` 
                : '<p class="text-sm text-red-500 mt-2 font-medium italic"><i class="fa-solid fa-triangle-exclamation"></i> Nenhuma cidade identificada.</p>';

            const headerHtml = `<div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mb-4"><div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><div><h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">${displayTitle} ${blockIndex === 0 ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Autom√°tico</span>' : ''}</h2>${citiesHtml}</div><div class="flex gap-2 self-end md:self-center">${buttonsHtml}</div></div></div>`;
            blockContainer.innerHTML = headerHtml;

            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto card';
            const orderHeader = blockIndex === 0 ? '<th class="px-4 py-3 text-center w-16 text-xs font-bold text-gray-600 uppercase">Ordem</th>' : '<th class="px-4 py-3 text-center w-10 text-xs font-bold text-gray-600 uppercase">#</th>';
            let specialColumnHeader = (selectedOfferType === 'SAVEGNAGO') ? '<th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Save Ganhe</th>' : '<th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Cliente Campe√£o</th>';

            let tableHtml = `<table class="min-w-full" id="table-${blockIndex}"><thead class="bg-gray-50 sticky-header"><tr><th class="px-4 py-3 text-center w-10"><i class="fa-solid fa-check"></i></th>${orderHeader}<th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">C√≥digo / Link</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Descri√ß√£o</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Pre√ßo Normal</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Nosso Cart√£o</th>${specialColumnHeader}<th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Info Extra</th></tr></thead><tbody class="divide-y divide-gray-200">`;

            let visibleRowsCount = 0;
            const refBlock = window.globalParsedBlocks.length > 0 ? window.globalParsedBlocks[0] : null;

            products.forEach((product, idx) => {
                const descId = `desc-${blockIndex}-${idx}`;
                const extraId = `extra-${blockIndex}-${idx}`;
                const rowClass = (visibleRowsCount % 2 === 0) ? 'bg-white' : 'bg-gray-50';
                const rawKey = product.code || product.description;
                const safeKey = rawKey.replace(/"/g, '&quot;'); 

                let showRow = true;
                let descContent = `<div class="flex justify-between items-center gap-2"><span id="${descId}">${product.description}</span><i class="fa-regular fa-copy text-gray-300"></i></div>`;
                
                let normalPriceContent = product.priceNormal ? formatPrice(product.priceNormal) : '<span class="text-[10px] text-gray-500 italic leading-tight block">Sem pre√ßo<br>informado</span>';
                
                let cellClassCard = "bg-blue-50 text-blue-900 border-x border-blue-100";
                let cellClassSpecial = (selectedOfferType === 'SAVEGNAGO') ? "bg-pink-50 text-pink-900 border-x border-pink-100" : "bg-red-50 text-red-900 border-x border-red-100";

                let cardPriceContent = formatPrice(product.priceNossoCartao);
                let specialPriceValue = (selectedOfferType === 'SAVEGNAGO') ? (product.priceSaveGanhe || '-') : (product.priceClienteCampeao || '-');
                let specialPriceContent = specialPriceValue !== '-' ? formatPrice(specialPriceValue) : '-';

                if (blockIndex > 0) {
                    const refProduct = refBlock && refBlock.products[idx];
                    let isDifferent = false;

                    if (!refProduct) {
                        isDifferent = true; 
                        descContent = `<div class="flex justify-between items-center gap-2"><span id="${descId}" class="text-green-700 font-bold">${product.description} <span class="text-xs bg-green-200 px-1 rounded ml-1">NOVO</span></span><i class="fa-regular fa-copy text-gray-300"></i></div>`;
                    } else {
                        if (product.description !== refProduct.description) {
                            isDifferent = true;
                            descContent = `<div class="flex flex-col gap-1"><span id="${descId}" class="text-red-600 font-bold">${product.description}</span><span class="text-[10px] text-red-500 line-through">Era: ${refProduct.description}</span></div>`;
                        }
                        if (product.priceNormal !== refProduct.priceNormal) {
                            isDifferent = true;
                            let newP = product.priceNormal ? formatPrice(product.priceNormal) : '<span class="text-[10px] text-gray-500 italic">Sem pre√ßo</span>';
                            let oldP = refProduct.priceNormal ? formatPrice(refProduct.priceNormal) : 'Sem pre√ßo';
                            normalPriceContent = `<div class="text-red-600 font-bold">${newP}</div><div class="text-[10px] text-red-500 mt-0.5">Era: ${oldP}</div>`;
                        }
                        
                        const currentCard = product.priceNossoCartao;
                        const refCard = refProduct.priceNossoCartao;
                        if (currentCard !== refCard) {
                            isDifferent = true;
                            if (currentCard && !refCard) {
                                cardPriceContent = `<div class="text-green-700 font-bold">${formatPrice(currentCard)}</div><div class="text-[10px] text-green-600 mt-0.5 font-bold">Adicionada</div>`;
                            } else if (currentCard && refCard) {
                                cardPriceContent = `<div class="text-red-600 font-bold">${formatPrice(currentCard)}</div><div class="text-[10px] text-red-500 mt-0.5">Era: ${formatPrice(refCard)}</div>`;
                            } else if (!currentCard && refCard) {
                                cardPriceContent = `<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">Removida</span><div class="text-[10px] text-gray-400 mt-1 line-through">Era: ${formatPrice(refCard)}</div>`;
                            }
                        }

                        let refSpecial = (selectedOfferType === 'SAVEGNAGO') ? refProduct.priceSaveGanhe : refProduct.priceClienteCampeao;
                        let currentSpec = (selectedOfferType === 'SAVEGNAGO') ? product.priceSaveGanhe : product.priceClienteCampeao;
                        let refSpecFinal = refSpecial || null;
                        let currentSpecFinal = currentSpec || null;

                        if (currentSpecFinal !== refSpecFinal) {
                            isDifferent = true;
                            if (currentSpecFinal && !refSpecFinal) {
                                specialPriceContent = `<div class="text-green-700 font-bold">${formatPrice(currentSpecFinal)}</div><div class="text-[10px] text-green-600 mt-0.5 font-bold">Adicionada</div>`;
                            } else if (currentSpecFinal && refSpecFinal) {
                                specialPriceContent = `<div class="text-red-600 font-bold">${formatPrice(currentSpecFinal)}</div><div class="text-[10px] text-red-500 mt-0.5">Era: ${formatPrice(refSpecFinal)}</div>`;
                            } else if (!currentSpecFinal && refSpecFinal) {
                                specialPriceContent = `<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">Removida</span><div class="text-[10px] text-gray-400 mt-1 line-through">Era: ${formatPrice(refSpecFinal)}</div>`;
                            }
                        }
                    }
                    if (!isDifferent) showRow = false; 
                }

                if (showRow) {
                    visibleRowsCount++;
                    const orderCell = blockIndex === 0 ? `<input type="number" class="order-input" placeholder="#">` : `<span class="text-gray-400 text-xs">${idx + 1}</span>`;
                    
                    tableHtml += `<tr class="${rowClass} hover:bg-gray-100 transition-colors" data-key="${safeKey}">
                        <td class="px-4 py-4 text-center"><input type="checkbox" class="w-5 h-5 text-green-600 rounded focus:ring-green-500 cursor-pointer" onchange="toggleRowCompletion(this)"></td>
                        <td class="px-4 py-4 text-center">${orderCell}</td>
                        <td class="px-4 py-4 whitespace-nowrap">${generateSkuLinks(product.code)}</td>
                        <td class="px-4 py-4 text-sm font-medium text-gray-900 cursor-pointer" onclick="copyAndAnimate('${product.description.replace(/'/g, "\\'")}', '${descId}')">${descContent}</td>
                        <td class="px-4 py-4 text-center text-gray-800 font-semibold">${normalPriceContent}</td>
                        <td class="px-4 py-4 text-center font-bold ${cellClassCard}">${cardPriceContent}</td>
                        <td class="px-4 py-4 text-center font-bold ${cellClassSpecial}">${specialPriceContent}</td>
                        <td class="px-4 py-4 text-center text-sm text-purple-700 italic bg-purple-50">${product.extraInfo ? `<span class="cursor-pointer" onclick="copyAndAnimate('${product.extraInfo.replace(/'/g, "\\'")}', '${extraId}')" id="${extraId}"><i class="fa-solid fa-circle-info mr-1"></i> ${product.extraInfo}</span>` : '<span class="text-gray-300">-</span>'}</td>
                    </tr>`;
                }
            });
            tableHtml += `</tbody></table>`;
            if (visibleRowsCount === 0 && blockIndex > 0) {
                tableHtml = `<div class="p-6 text-center text-gray-500 italic"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>Todos os produtos s√£o id√™nticos √† lista geral.</div>`;
            }
            tableContainer.innerHTML = tableHtml;
            blockContainer.appendChild(tableContainer);
            resultsContainer.appendChild(blockContainer);
        }

        document.getElementById('selectSavegnago').addEventListener('click', () => { selectedOfferType = 'SAVEGNAGO'; MASTER_CITIES = CITIES_SAVEGNAGO; document.getElementById('parseButton').className = "btn btn-savegnago w-full sm:w-auto"; document.getElementById('headerLogo').src = "https://savegnagoio.vtexassets.com/assets/vtex/assets-builder/savegnagoio.store-theme/14.0.36/home/logo-save___ee8753fa9fd1e21018b817a0d020549f.png"; toggleModal('listTypeModal', false); });
        document.getElementById('selectPaulistao').addEventListener('click', () => { selectedOfferType = 'PAULISTAO'; MASTER_CITIES = CITIES_PAULISTAO; document.getElementById('parseButton').className = "btn btn-paulistao w-full sm:w-auto"; document.getElementById('headerLogo').src = "https://paulistaoatacadista.vtexassets.com/assets/vtex.file-manager-graphql/images/91d1697e-7efa-471e-b763-68b8b71430b2___db630f93263bf9ecc924c4493e2279f9.png"; toggleModal('listTypeModal', false); });

        // LISTENER DO BOT√ÉO ANALISAR (COM PROTE√á√ÉO)
        document.getElementById('parseButton').addEventListener('click', async () => {
            const btn = document.getElementById('parseButton');
            const spinner = document.getElementById('loadingSpinner');
            const text = document.getElementById('inputText').value;
            const container = document.getElementById('resultsContainer');
            if (!text.trim()) { showToast("Cole um texto primeiro!", "error"); return; }
            if (!selectedOfferType) { toggleModal('listTypeModal', true); return; }
            
            try {
                btn.disabled = true; 
                spinner.classList.remove('hidden'); 
                container.innerHTML = ''; 
                window.globalParsedBlocks = [];
                await new Promise(r => setTimeout(r, 500)); // Pequeno delay visual
                
                const rawBlocks = text.trim().split(/\n\s*\n\s*/);
                rawBlocks.forEach((blockStr, index) => {
                    const rawLines = blockStr.trim().split('\n');
                    if (rawLines.length === 0) return;
                    let headerLines = [], productLines = [], foundProduct = false;
                    // Regex mais flex√≠vel para o tra√ßo
                    const productRegex = /.+[-‚Äì‚Äî]\s*R\$\s*[\d,.]+/;
                    for (let line of rawLines) {
                        const trimmed = line.trim();
                        if (!trimmed) continue;
                        if (!foundProduct) { if (productRegex.test(trimmed)) { foundProduct = true; productLines.push(trimmed); } else { headerLines.push(trimmed); } } else { productLines.push(trimmed); }
                    }
                    if (productLines.length === 0) return;
                    const fullHeader = headerLines.join(' ');
                    const products = parseProductBlock(productLines);
                    window.globalParsedBlocks.push({ header: fullHeader, locationTitle: fullHeader.split(/[-‚Äì‚Äî:]/)[0].trim(), cityList: [], products: products });
                });
                if (window.globalParsedBlocks.length > 0) parseCities(window.globalParsedBlocks);
                window.globalParsedBlocks.forEach((block, index) => { renderResultsTable(block.products, container, block.locationTitle, block.cityList, index); });
                showToast("An√°lise conclu√≠da!");
            } catch (error) {
                console.error(error);
                showToast("Erro ao analisar! Verifique o texto.", "error");
            } finally {
                spinner.classList.add('hidden'); 
                btn.disabled = false; 
            }
        });

        // BOT√ÉO LIMPAR
        document.getElementById('clearButton').addEventListener('click', () => { 
            document.getElementById('inputText').value = ''; 
            document.getElementById('resultsContainer').innerHTML = ''; 
            window.globalParsedBlocks = []; 
            showToast("Campos limpos!");
        });

        document.getElementById('increase-font').addEventListener('click', () => { document.documentElement.style.fontSize = (parseFloat(getComputedStyle(document.documentElement).fontSize) + 1) + 'px'; });
        document.getElementById('decrease-font').addEventListener('click', () => { document.documentElement.style.fontSize = (parseFloat(getComputedStyle(document.documentElement).fontSize) - 1) + 'px'; });
        document.getElementById('high-contrast').addEventListener('click', () => { document.body.classList.toggle('high-contrast'); });
        document.getElementById('reset-accessibility').addEventListener('click', () => { document.documentElement.style.fontSize = '16px'; document.body.classList.remove('high-contrast'); });
    </script>
</body>
</html>
